<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepairBox - Gestion Atelier</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RepairBox">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header glass">
            <h1>
                <span>âš¡</span>
                <span>RepairBox</span>
            </h1>
            <div class="header-actions">
                <div class="save-indicator" id="saveIndicator">
                    <span id="saveIcon">ğŸ’¾</span>
                    <span id="saveText">PrÃªt</span>
                </div>
                <div class="date-nav">
                    <button class="btn" onclick="changeDay(-1)">â€¹ Hier</button>
                    <span id="currentDate">Aujourd'hui</span>
                    <button class="btn" onclick="changeDay(1)">Demain â€º</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs glass">
            <div class="tab active" onclick="switchTab('planning')">ğŸ“… Planning</div>
            <div class="tab" onclick="switchTab('clients')">ğŸ‘¥ Clients</div>
            <div class="tab" onclick="switchTab('stats')">ğŸ“Š Stats</div>
            <div class="tab" onclick="switchTab('stock')">ğŸ“¦ Stock</div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Planning Section -->
            <main class="planning-section glass" id="planning-section">
                <div class="section-header">
                    <h2 class="section-title" id="dayTitle">Planning du Jour</h2>
                    <button class="add-btn" onclick="openDeviceModal()">
                        <span>â•</span>
                        <span>Nouvel Appareil</span>
                    </button>
                </div>

                <!-- Controls avec sÃ©lection multiple -->
                <div class="controls">
                    <input type="text" class="search-input" placeholder="ğŸ” Rechercher par client, modÃ¨le..." id="searchInput" oninput="filterDevices()">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">Tous</button>
                        <button class="filter-btn" data-filter="urgent" onclick="setFilter('urgent')">ğŸ”´ Urgents</button>
                        <button class="filter-btn" data-filter="repaired" onclick="setFilter('repaired')">âœ… RÃ©parÃ©s</button>
                        <button class="btn" onclick="toggleBulkSelect()">ğŸ“‹ SÃ©lection</button>
                    </div>
                </div>

                <!-- Actions groupÃ©es -->
                <div class="bulk-actions" id="bulkActions">
                    <div class="bulk-header">
                        <span><strong id="selectedCount">0</strong> appareil(s) sÃ©lectionnÃ©(s)</span>
                        <button class="btn" onclick="toggleBulkSelect()">âœ• Fermer</button>
                    </div>
                    <div class="bulk-buttons">
                        <button class="bulk-btn status" onclick="bulkChangeStatus()">ğŸ“ Changer Statut</button>
                        <button class="bulk-btn sms" onclick="bulkSendSMS()">ğŸ“± SMS GroupÃ©</button>
                        <button class="bulk-btn delete" onclick="bulkDelete()">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>

                <!-- Device List -->
                <div class="device-grid" id="deviceGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </main>

            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Stats avec charge de travail -->
                <div class="stats-card glass">
                    <h3 class="stats-title">ğŸ“ˆ Aujourd'hui</h3>
                    
                    <!-- Stats rapides -->
                    <div class="quick-stats">
                        <div class="quick-stat urgent">
                            <span class="quick-stat-number" id="urgentCount">0</span>
                            <span>Urgents</span>
                        </div>
                        <div class="quick-stat revenue">
                            <span class="quick-stat-number" id="todayEarnings">0â‚¬</span>
                            <span>GagnÃ©</span>
                        </div>
                    </div>

                    <!-- Charge de travail -->
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px;">
                            <span>Charge de travail</span>
                            <span id="workloadPercent">0%</span>
                        </div>
                        <div class="workload-bar">
                            <div class="workload-fill" id="workloadFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="repairedCount">0</div>
                            <div class="stat-label">RÃ©parÃ©s</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="revenueCount">0â‚¬</div>
                            <div class="stat-label">Revenus</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="pendingCount">0</div>
                            <div class="stat-label">En cours</div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="exportDay()">ğŸ“‹ Exporter</button>
                        <button class="btn" onclick="showWeekStats()">ğŸ“Š Stats Semaine</button>
                        <button class="btn" onclick="showClientHistory()">ğŸ‘¥ Historique Clients</button>
                    </div>

                    <!-- Gestion des sauvegardes -->
                    <div class="backup-section">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">ğŸ”„ Sauvegarde</h4>
                        <div class="backup-actions">
                            <button class="btn btn-small" onclick="exportBackup()">ğŸ“¤ Exporter</button>
                            <button class="btn btn-small" onclick="importBackup()">ğŸ“¥ Importer</button>
                            <button class="btn btn-small" onclick="clearAllData()">ğŸ—‘ï¸ Vider</button>
                        </div>
                        <div class="backup-info" id="backupInfo">
                            DerniÃ¨re sauvegarde: Jamais
                        </div>
                        <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="handleBackupImport(event)">
                    </div>
                </div>

                <!-- Rappels -->
                <div class="stats-card glass glass-darker">
                    <h3 class="stats-title">ğŸ”” Rappels</h3>
                    <div class="reminders-list" id="remindersList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Analytics enrichies -->
                <div class="stats-card glass analytics-card">
                    <h3 class="stats-title">ğŸ“Š Analytics</h3>
                    <div class="analytics-grid" id="analyticsGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content glass qr-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="qrModalTitle">ğŸ“± Code QR Appareil</h3>
                <button class="close-btn" onclick="closeQRModal()">&times;</button>
            </div>
            
            <div class="qr-code-display" id="qrCodeDisplay">
                <!-- QR Code will be generated here -->
            </div>
            
            <div class="qr-actions">
                <button class="btn" onclick="printQRLabel()">ğŸ–¨ï¸ Imprimer Ã‰tiquette</button>
                <button class="btn btn-primary" onclick="downloadQRCode()">ğŸ“¥ TÃ©lÃ©charger</button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: var(--bg-glass-dark); border-radius: 10px;">
                <h4>Scanner un QR Code</h4>
                <input type="file" id="qrFileInput" accept="image/*" style="margin: 10px 0;">
                <button class="btn" onclick="startQRScan()">ğŸ“· Scanner depuis CamÃ©ra</button>
                <div id="qrScanResult" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Photo Reminder Notification -->
    <div class="photo-reminder hidden" id="photoReminder">
        <div>ğŸ“¸ Photo requise</div>
        <small>Cliquez pour ajouter</small>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>

    <!-- Device Modal -->
    <div class="modal" id="deviceModal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">ğŸ“± Nouvel Appareil</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="deviceForm" onsubmit="handleSubmit(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Client *</label>
                        <input type="text" class="form-input" id="clientName" required placeholder="Nom du client" list="clientsList">
                        <datalist id="clientsList"></datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">TÃ©lÃ©phone</label>
                        <input type="tel" class="form-input" id="clientPhone" placeholder="06 12 34 56 78">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Appareil *</label>
                    <input type="text" class="form-input" id="deviceModel" required placeholder="iPhone 15, Samsung Galaxy S24..." list="devicesList">
                    <datalist id="devicesList"></datalist>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">ProblÃ¨me *</label>
                    <textarea class="form-textarea" id="deviceProblem" required placeholder="DÃ©crivez le problÃ¨me rencontrÃ©..."></textarea>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Prix (â‚¬)</label>
                        <input type="number" class="form-input" id="devicePrice" placeholder="0" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Temps estimÃ© (heures)</label>
                        <input type="number" class="form-input" id="deviceDuration" placeholder="2" step="0.5" min="0" max="48">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Statut</label>
                        <select class="form-select" id="deviceStatus">
                            <option value="received">ğŸ“¥ ReÃ§u</option>
                            <option value="diagnostic">ğŸ” Diagnostic</option>
                            <option value="waiting">â³ Attente piÃ¨ces</option>
                            <option value="repaired">âœ… RÃ©parÃ©</option>
                            <option value="delivered">ğŸšš LivrÃ©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Urgence</label>
                        <select class="form-select" id="deviceUrgency">
                            <option value="normal">ğŸŸ¢ Normal</option>
                            <option value="urgent">ğŸŸ  Urgent</option>
                            <option value="express">ğŸ”´ Express 24h</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">PrioritÃ©</label>
                        <select class="form-select" id="devicePriority">
                            <option value="normal">ğŸŸ¢ Normale</option>
                            <option value="high">ğŸŸ  Haute</option>
                            <option value="critical">ğŸ”´ Critique</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Garantie</label>
                        <select class="form-select" id="deviceWarranty">
                            <option value="3">3 mois</option>
                            <option value="6">6 mois</option>
                            <option value="12">12 mois</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">PiÃ¨ces nÃ©cessaires</label>
                    <input type="text" class="form-input" id="deviceParts" placeholder="Ã‰cran, batterie, camÃ©ra..." list="partsList">
                    <datalist id="partsList"></datalist>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Photos</label>
                    <div class="photo-grid">
                        <div class="photo-area" onclick="triggerPhotoUpload('before')">
                            <div id="beforePreview">ğŸ“¸<br><small>Avant</small></div>
                        </div>
                        <div class="photo-area" onclick="triggerPhotoUpload('after')">
                            <div id="afterPreview">ğŸ“¸<br><small>AprÃ¨s</small></div>
                        </div>
                    </div>
                    <input type="file" id="beforePhoto" accept="image/*" style="display: none;" onchange="handlePhotoUpload('before')">
                    <input type="file" id="afterPhoto" accept="image/*" style="display: none;" onchange="handlePhotoUpload('after')">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>