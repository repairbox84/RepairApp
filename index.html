<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepairBox - Gestion Atelier</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RepairBox">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header glass">
            <h1>
                <span>⚡</span>
                <span>RepairBox</span>
            </h1>
            <div class="header-actions">
                <div class="save-indicator" id="saveIndicator">
                    <span id="saveIcon">💾</span>
                    <span id="saveText">Prêt</span>
                </div>
                <div class="date-nav">
                    <button class="btn" onclick="changeDay(-1)">‹ Hier</button>
                    <span id="currentDate">Aujourd'hui</span>
                    <button class="btn" onclick="changeDay(1)">Demain ›</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs glass">
            <div class="tab active" onclick="switchTab('planning')">📅 Planning</div>
            <div class="tab" onclick="switchTab('clients')">👥 Clients</div>
            <div class="tab" onclick="switchTab('stats')">📊 Stats</div>
            <div class="tab" onclick="switchTab('stock')">📦 Stock</div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Planning Section -->
            <main class="planning-section glass" id="planning-section">
                <div class="section-header">
                    <h2 class="section-title" id="dayTitle">Planning du Jour</h2>
                    <button class="add-btn" onclick="openDeviceModal()">
                        <span>➕</span>
                        <span>Nouvel Appareil</span>
                    </button>
                </div>

                <!-- Controls avec sélection multiple -->
                <div class="controls">
                    <input type="text" class="search-input" placeholder="🔍 Rechercher par client, modèle..." id="searchInput" oninput="filterDevices()">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">Tous</button>
                        <button class="filter-btn" data-filter="urgent" onclick="setFilter('urgent')">🔴 Urgents</button>
                        <button class="filter-btn" data-filter="repaired" onclick="setFilter('repaired')">✅ Réparés</button>
                        <button class="btn" onclick="toggleBulkSelect()">📋 Sélection</button>
                    </div>
                </div>

                <!-- Actions groupées -->
                <div class="bulk-actions" id="bulkActions">
                    <div class="bulk-header">
                        <span><strong id="selectedCount">0</strong> appareil(s) sélectionné(s)</span>
                        <button class="btn" onclick="toggleBulkSelect()">✕ Fermer</button>
                    </div>
                    <div class="bulk-buttons">
                        <button class="bulk-btn status" onclick="bulkChangeStatus()">📝 Changer Statut</button>
                        <button class="bulk-btn sms" onclick="bulkSendSMS()">📱 SMS Groupé</button>
                        <button class="bulk-btn delete" onclick="bulkDelete()">🗑️ Supprimer</button>
                    </div>
                </div>

                <!-- Device List -->
                <div class="device-grid" id="deviceGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </main>

            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Stats avec charge de travail -->
                <div class="stats-card glass">
                    <h3 class="stats-title">📈 Aujourd'hui</h3>
                    
                    <!-- Stats rapides -->
                    <div class="quick-stats">
                        <div class="quick-stat urgent">
                            <span class="quick-stat-number" id="urgentCount">0</span>
                            <span>Urgents</span>
                        </div>
                        <div class="quick-stat revenue">
                            <span class="quick-stat-number" id="todayEarnings">0€</span>
                            <span>Gagné</span>
                        </div>
                    </div>

                    <!-- Charge de travail -->
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px;">
                            <span>Charge de travail</span>
                            <span id="workloadPercent">0%</span>
                        </div>
                        <div class="workload-bar">
                            <div class="workload-fill" id="workloadFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="repairedCount">0</div>
                            <div class="stat-label">Réparés</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="revenueCount">0€</div>
                            <div class="stat-label">Revenus</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="pendingCount">0</div>
                            <div class="stat-label">En cours</div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="exportDay()">📋 Exporter</button>
                        <button class="btn" onclick="showWeekStats()">📊 Stats Semaine</button>
                        <button class="btn" onclick="showClientHistory()">👥 Historique Clients</button>
                    </div>

                    <!-- Gestion des sauvegardes -->
                    <div class="backup-section">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">🔄 Sauvegarde</h4>
                        <div class="backup-actions">
                            <button class="btn btn-small" onclick="exportBackup()">📤 Exporter</button>
                            <button class="btn btn-small" onclick="importBackup()">📥 Importer</button>
                            <button class="btn btn-small" onclick="clearAllData()">🗑️ Vider</button>
                        </div>
                        <div class="backup-info" id="backupInfo">
                            Dernière sauvegarde: Jamais
                        </div>
                        <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="handleBackupImport(event)">
                    </div>
                </div>

                <!-- Rappels -->
                <div class="stats-card glass glass-darker">
                    <h3 class="stats-title">🔔 Rappels</h3>
                    <div class="reminders-list" id="remindersList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Analytics enrichies -->
                <div class="stats-card glass analytics-card">
                    <h3 class="stats-title">📊 Analytics</h3>
                    <div class="analytics-grid" id="analyticsGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content glass qr-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="qrModalTitle">📱 Code QR Appareil</h3>
                <button class="close-btn" onclick="closeQRModal()">&times;</button>
            </div>
            
            <div class="qr-code-display" id="qrCodeDisplay">
                <!-- QR Code will be generated here -->
            </div>
            
            <div class="qr-actions">
                <button class="btn" onclick="printQRLabel()">🖨️ Imprimer Étiquette</button>
                <button class="btn btn-primary" onclick="downloadQRCode()">📥 Télécharger</button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: var(--bg-glass-dark); border-radius: 10px;">
                <h4>Scanner un QR Code</h4>
                <input type="file" id="qrFileInput" accept="image/*" style="margin: 10px 0;">
                <button class="btn" onclick="startQRScan()">📷 Scanner depuis Caméra</button>
                <div id="qrScanResult" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Photo Reminder Notification -->
    <div class="photo-reminder hidden" id="photoReminder">
        <div>📸 Photo requise</div>
        <small>Cliquez pour ajouter</small>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>

    <!-- Device Modal -->
    <div class="modal" id="deviceModal">
        <div class="modal-content glass">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">📱 Nouvel Appareil</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="deviceForm" onsubmit="handleSubmit(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Client *</label>
                        <input type="text" class="form-input" id="clientName" required placeholder="Nom du client" list="clientsList">
                        <datalist id="clientsList"></datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Téléphone</label>
                        <input type="tel" class="form-input" id="clientPhone" placeholder="06 12 34 56 78">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Appareil *</label>
                    <input type="text" class="form-input" id="deviceModel" required placeholder="iPhone 15, Samsung Galaxy S24..." list="devicesList">
                    <datalist id="devicesList"></datalist>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Problème *</label>
                    <textarea class="form-textarea" id="deviceProblem" required placeholder="Décrivez le problème rencontré..."></textarea>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Prix (€)</label>
                        <input type="number" class="form-input" id="devicePrice" placeholder="0" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Temps estimé (heures)</label>
                        <input type="number" class="form-input" id="deviceDuration" placeholder="2" step="0.5" min="0" max="48">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Statut</label>
                        <select class="form-select" id="deviceStatus">
                            <option value="received">📥 Reçu</option>
                            <option value="diagnostic">🔍 Diagnostic</option>
                            <option value="waiting">⏳ Attente pièces</option>
                            <option value="repaired">✅ Réparé</option>
                            <option value="delivered">🚚 Livré</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Urgence</label>
                        <select class="form-select" id="deviceUrgency">
                            <option value="normal">🟢 Normal</option>
                            <option value="urgent">🟠 Urgent</option>
                            <option value="express">🔴 Express 24h</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Priorité</label>
                        <select class="form-select" id="devicePriority">
                            <option value="normal">🟢 Normale</option>
                            <option value="high">🟠 Haute</option>
                            <option value="critical">🔴 Critique</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Garantie</label>
                        <select class="form-select" id="deviceWarranty">
                            <option value="3">3 mois</option>
                            <option value="6">6 mois</option>
                            <option value="12">12 mois</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Pièces nécessaires</label>
                    <input type="text" class="form-input" id="deviceParts" placeholder="Écran, batterie, caméra..." list="partsList">
                    <datalist id="partsList"></datalist>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Photos</label>
                    <div class="photo-grid">
                        <div class="photo-area" onclick="triggerPhotoUpload('before')">
                            <div id="beforePreview">📸<br><small>Avant</small></div>
                        </div>
                        <div class="photo-area" onclick="triggerPhotoUpload('after')">
                            <div id="afterPreview">📸<br><small>Après</small></div>
                        </div>
                    </div>
                    <input type="file" id="beforePhoto" accept="image/*" style="display: none;" onchange="handlePhotoUpload('before')">
                    <input type="file" id="afterPhoto" accept="image/*" style="display: none;" onchange="handlePhotoUpload('after')">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">💾 Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>